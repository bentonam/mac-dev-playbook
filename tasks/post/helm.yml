---
- name: Check whether Helm is installed
  ansible.builtin.command: helm version --short
  register: helm_version_check
  changed_when: false
  failed_when: false

- name: Configure Helm repositories
  when: helm_version_check.rc == 0
  block:
    - name: Ensure configured Helm repos are present (and updated if URL changes)
      ansible.builtin.command: helm repo add {{ item.name }} {{ item.url }} --force-update
      register: helm_repo_add
      changed_when: >-
        ('has been added' in (helm_repo_add.stdout | lower))
        or ('has been updated' in (helm_repo_add.stdout | lower))
      loop: "{{ helm_repositories | default([]) }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Update Helm repo index (only if any repo changed)
      ansible.builtin.command: helm repo update
      changed_when: true
      when: helm_repo_add is changed
